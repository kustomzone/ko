#!/bin/bash

_NAME="ko.app"

while getopts ":thpdDVv" opt; do
    case "$opt" in
        t)
            _DEV=1
            ;;
        h|p|d|D|V|v)
            _LOG=1
            ;;
  esac
done

if [ $_DEV ]; then
    killall Electron 2> /dev/null
    killall Electron 2> /dev/null
    cd ~/s/ko
    ./node_modules/electron-prebuilt/cli.js ./js/main.js "$@" &
    exit 0
elif [ -x "/Applications/$_NAME" ]; then
    _PATH="/Applications"
elif [ -x "$HOME/Applications/$_NAME" ]; then
    _PATH="$HOME/Applications"
elif [ -x "$HOME/s/ko/dist/mac/$_NAME" ]; then
    _PATH="$HOME/s/ko/dist/mac"
    echo "using dev build $_PATH"
else
    _PATH="$(mdfind \"kMDItemCFBundleIdentifier == 'net.monsterkodi.ko'\" | grep -v ShipIt | head -1 | xargs -0 dirname)"
    if [ ! -x "$_PATH/$_NAME" ]; then
        node "`dirname $0`/../lib/node_modules/ko-editor/bin/download.js" $*
        exit 0
    fi
fi

if [ $_LOG ]; then
    echo "$_PATH/$_NAME/Contents/MacOS/ko"
    "$_PATH/$_NAME/Contents/MacOS/ko" "$(pwd)" "$@"
    exit $?
else
    echo "open $_PATH/$_NAME"
    open -a "$_PATH/$_NAME" --args app "$(pwd)" "$@"
fi
