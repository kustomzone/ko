#!/bin/bash

_NAME="ko.app"

while getopts ":thpdDV" opt; do
    case "$opt" in
        t)
            _DEV=1
            ;;
        h|p|d|D|V)
            _LOG=1
            ;;
  esac
done

if [ $_DEV ]; then
    killall Electron 2> /dev/null
    killall Electron 2> /dev/null
    cd ~/s/ko
    ./node_modules/electron-prebuilt/cli.js ./js/main.js "$@" &
    exit 0
elif [ -x "/Applications/$_NAME" ]; then
    _PATH="/Applications"
elif [ -x "$HOME/Applications/$_NAME" ]; then
    _PATH="$HOME/Applications"
else
    _PATH="$(mdfind \"kMDItemCFBundleIdentifier == 'net.monsterkodi.ko'\" | grep -v ShipIt | head -1 | xargs -0 dirname)"
    if [ ! -x "$_PATH/$_NAME" ]; then
        node "`dirname $0`/../lib/node_modules/ko/bin/download.js" $*
        exit 0
    fi
fi

if [ $_LOG ]; then
    # echo "$_PATH/$_NAME/Contents/MacOS/ko"
    "$_PATH/$_NAME/Contents/MacOS/ko" --executed-from="$(pwd)" "$@"
    exit $?
else
    # echo "open $_PATH/$_NAME"
    open -a "$_PATH/$_NAME" -n --args --executed-from="$(pwd)" --path-environment="$_PATH" "$@"
fi